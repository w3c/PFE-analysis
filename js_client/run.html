<!doctype html>
<html>
  <head>
    <script src="./patch_subset_wasm.js"></script>
    <script>

      const SENTENCES = [
          'Almost before we knew it, we had left the ground.',
          'All their equipment and instruments are alive.',
          'A red flare silhouetted the jagged edge of a wing.',
          'I watched the storm, so beautiful yet terrific.',
          'A shining crescent far beneath the flying vessel.',
          'It was going to be a lonely trip back.',
          'Mist enveloped the ship three hours out from port.',
          'My two natures had memory in common.',
          'Silver mist suffused the deck of the ship.',
          'The face of the moon was in shadow.',
          'She stared through the window at the stars.',
          'The recorded voice scratched in the speaker.',
          'The sky was cloudless and of a deep dark blue.',
          'The spectacle before us was indeed sublime.',
          'Then came the night of the first falling star.',
          'Waves flung themselves at the blue evening.',
      ];

      const PARAGRAPHS = [
          'A peep at some distant orb has power to raise and purify our thoughts like a strain of sacred music, or a noble picture, or a passage from the grander poets. It always does one good.',
          'Apparently we had reached a great height in the atmosphere, for the sky was a dead black, and the stars had ceased to twinkle. By the same illusion which lifts the horizon of the sea to the level of the spectator on a hillside, the sable cloud beneath was dished out, and the car seemed to float in the middle of an immense dark sphere, whose upper half was strewn with silver.',
          'As I went on, still gaining velocity, the palpitation of night and day merged into one continuous greyness; the sky took on a wonderful deepness of blue, a splendid luminous color like that of early twilight; the jerking sun became a streak of fire, a brilliant arch, in space; the moon a fainter fluctuating band; and I could see nothing of the stars, save now and then a brighter circle flickering in the blue.',
          'As the minuteness of the parts formed a great hindrance to my speed, I resolved, contrary to my first intention, to make the being of a gigantic stature; that is to say, about eight feet in height, and proportionably large. After having formed this determination, and having spent some months in successfully collecting and arranging my materials, I began.',
          'I shall see the face of Mars, anyhow, and that will be a rare experience. It seems to me that a view of the heavenly bodies through a fine telescope, as well as a tour round the world, should form a part of a liberal education.',
          'Though the gravity still dragged at him, his muscles were making great efforts to adjust. After the daily classes he no longer collapsed immediately into bed. Only the nightmares got worse.',
          'Truly it was a great journey, and in it I met with many, whom to know was to love; but whom never could I see again; for life has not space enough; and each must do his duty to the security and well-being of the Redoubt. Yet, for all that I have set down, we travelled much, always; but there were so many millions, and so few years.',
          'What looked like a small patch of purple grass, above five feet square, was moving across the sand in their direction. When it came near enough he perceived that it was not grass; there were no blades, but only purple roots. The roots were revolving, for each small plant in the whole patch, like the spokes of a rimless wheel.',
      ];

      var page_index = 0;
      var states = {};

      function update_all_fonts() {
          update_fonts(document.getElementById("title"),
                       SENTENCES[page_index],
                       "Roboto-Thin.ttf",
                       "R Thin");
          update_fonts(document.getElementById("paragraph"),
                       PARAGRAPHS[page_index],
                       "Roboto-Regular.ttf",
                       "R Regular");

          document.getElementById("prev").disabled = (page_index == 0);
          document.getElementById("next").disabled = (page_index == PARAGRAPHS.length - 1);
      }

      function update_fonts(element, text, font_id, font_face) {
          cps = new Set()
          for (var i = 0; i < text.length; i++) {
              cps.add(text.charCodeAt(i));
          }

          cps_array = []
          for (let cp of cps) {
              cps_array.push(cp);
          }

          patch_codepoints(element, text, font_id, font_face, cps_array);
      }

      function patch_codepoints(element, text, font_id, font_face, cps) {
          if (!states[font_face]) {
              states[font_face] = new window.Module.State(font_id);
          }
          var state = states[font_face];
          state.extend(cps, async function(result) {
              font = state.font_data();
              font = new FontFace(font_face, font);
              document.fonts.add(font);
              await font.load();
              element.textContent = text;
          });
      }

      createModule().then(function(Module) {
          window.Module = Module;
          update_all_fonts();
      });

      window.addEventListener('DOMContentLoaded', function() {
          prev = document.getElementById("prev");
          prev.addEventListener("click", function() {
              page_index--;
              if (page_index < 0) page_index = 0;
              update_all_fonts();
          });
          next = document.getElementById("next");
          next.addEventListener("click", function() {
              page_index++;
              if (page_index >= PARAGRAPHS.length) page_index = PARAGRAPHS.length - 1;
              update_all_fonts();
          });
      });
    </script>
    <style>
      h1 {
          font-family: "R Thin", cursive;
          font-size: 3em;
      }
      p {
          font-family: "R Regular", cursive;
          font-size: 2em;
      }
      input {
          font-size: 1.5em;
      }
    </style>
  </head>
  <body>
    <div>
      <input type="button" value="Previous" id="prev"/>
      <input type="button" value="Next" id="next"/>
    </div>
    <h1 id="title">
    </h1>
    <p id="paragraph">
    </p>
  </body>
</html>
